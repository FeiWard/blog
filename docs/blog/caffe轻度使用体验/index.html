<!DOCTYPE html>
<html lang="en-US">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="Example blog">


<meta property="twitter:title" content="caffe轻度使用体验">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:image" content="img/banner.png">

<meta property="twitter:description" content="">

<base href="">
<title>


      - caffe轻度使用体验 

</title>
<link rel="canonical" href="blog/caffe%E8%BD%BB%E5%BA%A6%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/">


<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="css/ionicons.min.css">


  <link rel="stylesheet" href="css/highlight.min.css">



  <link rel="stylesheet" href="css/progressively.min.css">





<link rel="shortcut icon"

    href="img/favicon.ico"

>



</head>


<body lang="">


<section class="header"> 

    <div class="container">
        <a href=""><img class="logo" src="img/logo.png" alt="logo" /></a>
        <div class="content">
            <a href=""><div class="name"><h1></h1></div></a>
            <nav>
                <ul>
                    
                        <a href="blog/"><li>Blog</li></a>
                    
                    
                        
                    
                        
                            
                        
                    
                        
                            
                            <a href="projects"><li>projects</li></a>
                            
                        
                    
                    
                        
                            <a href="/about/"><li>About</li></a>
                        
                    
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">

        
        
        

        

        

        
            <a href="/index.xml">
                <i class="icon ion-social-rss larger" title="rss"></i>
            </a>
        
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    caffe轻度使用体验

</div>

                </div>
                <div class="meta">
                    <div class="date" title="Thu May 5 2016 21:39:28 UTC">May 5, 2016</div>
                    <div class="reading-time"><div class="middot"></div>2 minutes read</div>
                </div>
            </div>
            <div class="markdown">
                
                    <h1 id="简单说明">简单说明</h1>

<p>caffe毫无疑问是现在使用比较广泛的深度学习网络框架，每一个学习卷积神经网络的人，应该都不可避免要体验一下caffe的特性和魔力。</p>

<p>由于第一次在装cuda时，不小心将ubuntu装死，导致在登陆界面无法登陆，输入正确密码后闪一两秒钟然后又回到登陆界面。用谷歌搜索各种解决方法均无效后，索性重装系统，然后记录每一步。</p>

<p></p>

<h1 id="安装步骤">安装步骤</h1>

<ul>
<li>MATLAB</li>
</ul>

<p>MATLAB的安装按照官方说明即可，一般没有什么坑。需要注意的是，MATLAB的版本与cuda的版本有一个对应关系，在caffe官网有详细说明，在此不表。</p>

<ul>
<li>Python</li>
</ul>

<p>推荐使用anaconda。安装完毕之后，如果无法忍受conda下载速度慢，可以添加<a href="https://mirrors.tuna.tsinghua.edu.cn/help/anaconda/">清华源</a>。</p>

<pre><code>conda config --add channels 'https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/'
conda config --set show_channel_urls yes
</code></pre>

<ul>
<li>cuda</li>
</ul>

<p>之前装cuda将系统装死，很有可能是因为一些依赖库没有装好。因此在装cuda之前，最好将<a href="http://caffe.berkeleyvision.org/install_apt.html">caffe ubuntu installation</a>中说明的依赖库</p>

<pre><code>  sudo apt-get install libprotobuf-dev libleveldb-dev libsnappy-dev libopencv-dev libhdf5-serial-dev protobuf-compiler

  sudo apt-get install --no-install-recommends libboost-all-dev
</code></pre>

<p>全都确认安装成功后，再更新系统内核以及软件包</p>

<pre><code>  sudo apt-get update &amp;&amp; sudo apt-get upgrade -y

</code></pre>

<p>最后再安装cuda</p>

<pre><code>  sudo dpkg -i cuda*.deb

  sudo apt-get update &amp;&amp; sudo apt-get dist-upgrade

  sudo apt-get install cuda
</code></pre>

<p>重启系统后，确认英伟达驱动是否已正确安装。
  这时，还需要将cuda添加到系统路径，修改路径<code>～/.bashrc</code>，请根据个人软件路径以及软件版本相应添加以下内容</p>

<pre><code>  export PATH=/usr/local/cuda-7.5/bin:$PATH

  export LD_LIBRARY_PATH=/usr/local/cuda-7.5/lib64:$LD_LIBRARY_PATH
</code></pre>

<p>然后<code>source ~/.bashrc</code>使得修改结果生效，输入<code>nvcc -V</code>确认路径添加正确，此时cuda安装完毕。</p>

<ul>
<li>caffe
首先进入python文件夹，将Python依赖包全部安装
<code>for req in $(cat requirements.txt); do pip install $req; done</code>
然后在caffe根目录
<code>cp Makefile.config.example Makefile.config</code>
打开Makefile.config后，添加MATLAB和Python的路径（如果装了anaconda那就是配置anaconda的路径）。
然后就可以编译测试了</li>
</ul>

<pre><code>make all
make test
make runtest
</code></pre>

<p>没有错误的话，就可以进行Python接口和MATLAB接口的编译了。</p>

<pre><code>  make pycaffe
  make matcaffe
</code></pre>

<p>至此caffe安装结束。</p>

<h1 id="caffe使用">caffe使用</h1>

<p>caffe官方的mnist,imagenet等几个例子都写得非常详细，按照文档一步一步来，跑几个demo都是比较简单的。跑完demo后，如何用自己的数据来训练网络呢？</p>

<p>参考imagenet的实例以及<a href="http://sites.duke.edu/rachelmemo/2015/04/03/train-and-test-lenet-on-your-own-dataset/">train-and-test-lenet-on-your-dataset</a>后，摸清楚了如何训练自己的数据了。</p>

<p>首先将原始数据准备好，比如我的路径是<code>～/Documents/datasets/mw</code>，该目录下有两个文件夹<code>pos</code>和<code>neg</code>分别存放正负样本图片。caffe的实例中，训练数据都是放在<code>caffe/data</code>中，因此需要将图片分为test,val以及test（或者简单点只需要分为train和test即可）同时需要在该目录下生成一个train.txt，val.txt以及test.txt（简单相应只需要train.txt和test.txt），txt文件内容，每一行都是相应图片以及标签。因此为了方便完成这个数据预处理工作，我写了一个Python脚本</p>

<pre><code class="language-python"># -*- coding:utf-8 -*-
import os
import shutil
import random
import math

LABEL = [1,0]
src_pathbase = '/home/camel/Documents/datasets/mw/'
PATH = [src_pathbase+cate for cate in ['pos','neg']]
# print PATH

des_pathbase = '/home/camel/Documents/caffe/data/mw/'
DPATH = [des_pathbase+cate for cate in ['train','val','test']]
# print DPATH

for txt in ['train.txt','val.txt','test.txt']:
	open(des_pathbase+txt,'w').close()
for p in DPATH:
	if os.path.exists(p):
		shutil.rmtree(p)
	os.makedirs(p)


for k in xrange(len(PATH)):
	img_files = os.listdir(PATH[k])
	img_num = len(img_files)
	train_num = int(math.ceil(img_num * 0.9))
	test_num = img_num - train_num
	val_num = int(math.ceil(train_num * 0.1))
	train_num = train_num - val_num
	test_list = sorted(random.sample(xrange(img_num),test_num))
	train_val_list = list(set(xrange(img_num))-set(test_list))
	val_list = sorted(random.sample(train_val_list,val_num))
	train_list = list(set(train_val_list)-set(val_list))
	print img_num,train_num,val_num,test_num
	print train_list,len(train_list)
	print val_list,len(val_list)
	print test_list,len(test_list)

	for n in xrange(img_num):
		fpath = os.path.join(PATH[k],img_files[n])
		print fpath
		if n in train_list:
			print &quot;belongs to train&quot;
			with open('/home/camel/Documents/caffe/data/mw/train.txt','a') as f:
				f.write(&quot;%s %d&quot; % (img_files[n],LABEL[k]))
				f.write('\n')
			shutil.copy(fpath,DPATH[0])
		elif n in val_list:
			print &quot;belongs to val&quot;
			with open('/home/camel/Documents/caffe/data/mw/val.txt','a') as f:
				f.write(&quot;%s %d&quot; % (img_files[n],LABEL[k]))
				f.write('\n')
			shutil.copy(fpath,DPATH[1])
		elif n in test_list:
			print &quot;belongs to test&quot;
			with open('/home/camel/Documents/caffe/data/mw/test.txt','a') as f:
				f.write(&quot;%s %d&quot; % (img_files[n],LABEL[k]))
				f.write('\n')
			shutil.copy(fpath,DPATH[2])

</code></pre>

<p>数据准备好之后，将imagenet下的create_imagenet.sh拷贝到<code>caffe/examples/mw</code>下，作一些修改，我的修改如下，可根据自己的目录进行相应调整</p>

<pre><code>EXAMPLE=examples/mw
DATA=data/mw
TRAIN_DATA_ROOT=data/mw/train/
VAL_DATA_ROOT=data/mw/val/

echo &quot;Creating train lmdb...&quot;

GLOG_logtostderr=1 $TOOLS/convert_imageset \
    --resize_height=$RESIZE_HEIGHT \
    --resize_width=$RESIZE_WIDTH \
    --shuffle \
    --gray \
    $TRAIN_DATA_ROOT \
    $DATA/train.txt \
    $EXAMPLE/mw_train_lmdb

echo &quot;Creating val lmdb...&quot;

GLOG_logtostderr=1 $TOOLS/convert_imageset \
    --resize_height=$RESIZE_HEIGHT \
    --resize_width=$RESIZE_WIDTH \
    --shuffle \
    --gray \
    $VAL_DATA_ROOT \
    $DATA/val.txt \
    $EXAMPLE/mw_val_lmdb
</code></pre>

<p>那么运行该脚本后，就会将自己的数据生成caffe可处理的数据格式了。其他的就是将train_test.prototxt进行相应的修改，数据上主要修改source下的目录，对应刚刚生成的文件，比如我的就是<code>source: &quot;examples/mw/mw_train_lmdb&quot;</code>和<code>source: &quot;examples/mw/mw_val_lmdb&quot;</code>。</p>

<p>至此，将自己的数据应用到caffe上大部分都完成了，剩下的就是根据lenet或者imagenet参考设计修改CNN结构。在此不赘述了。</p>
                
                <br>
                <p><a href="blog">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                
            </div>
        </div>
    </div>
</section>


  <script src="js/highlight.min.js" defer></script>
  



  <script src="js/progressively.min.js" defer></script>


<script>
  window.onload = function() {
    
      hljs.initHighlighting();
    
    
      progressively.init({delay: 30, throttle: 50});
    
  };
</script>

</body>
</html>

