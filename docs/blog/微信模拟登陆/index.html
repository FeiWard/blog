<!DOCTYPE html>
<html lang="en-US">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="Example blog">


<meta property="twitter:title" content="微信模拟登陆">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:image" content="img/banner.png">

<meta property="twitter:description" content="">

<base href="">
<title>


      - 微信模拟登陆 

</title>
<link rel="canonical" href="blog/%E5%BE%AE%E4%BF%A1%E6%A8%A1%E6%8B%9F%E7%99%BB%E9%99%86/">


<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="css/ionicons.min.css">


  <link rel="stylesheet" href="css/highlight.min.css">



  <link rel="stylesheet" href="css/progressively.min.css">





<link rel="shortcut icon"

    href="img/favicon.ico"

>



</head>


<body lang="">


<section class="header"> 

    <div class="container">
        <a href=""><img class="logo" src="img/logo.png" alt="logo" /></a>
        <div class="content">
            <a href=""><div class="name"><h1></h1></div></a>
            <nav>
                <ul>
                    
                        <a href="blog/"><li>Blog</li></a>
                    
                    
                        
                    
                        
                            
                        
                    
                        
                            
                            <a href="projects"><li>projects</li></a>
                            
                        
                    
                    
                        
                            <a href="/about/"><li>About</li></a>
                        
                    
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">

        
        
        

        

        

        
            <a href="/index.xml">
                <i class="icon ion-social-rss larger" title="rss"></i>
            </a>
        
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    微信模拟登陆

</div>

                </div>
                <div class="meta">
                    <div class="date" title="Sat Jan 16 2016 04:27:58 UTC">Jan 16, 2016</div>
                    <div class="reading-time"><div class="middot"></div>3 minutes read</div>
                </div>
            </div>
            <div class="markdown">
                
                    <h2 id="微信公众号">微信公众号</h2>

<p>近来开了一个公众号，之前做了一个校园家教、讲座、校车等零碎信息的聚合，主要也是基于python的爬虫。但是由于是免费的个人订阅号用户，开发者模式下的限制还是比较多的，比如开发模式下无法创建菜单就是一个令人无比心痛的限制。而且基于微信的理念，主动推送消息一直也是微信所不欢迎的。但是有了模拟登陆，普通用户也可以主动发送消息给订阅者了，当然，由于微信公众号的明确规定，48小时内该订阅者未主动发送消息给公众号，则该公众号无法主动发送消息给订阅者。这条限制就没有办法了，不过基于模拟登陆，可以做的事还是挺多的，比如监控女朋友的知乎、微博等动态，一有新消息就通过公众号推送给自己；监控自己的公交卡余额，低于某阈值则通过公众号将余额推送给自己，方便自己的出行。</p>

<p></p>

<h2 id="python爬虫">python爬虫</h2>

<p>这次微信公众号的模拟登陆抛弃了urllib和urllib2，而选择了requests，相对于前者，后者的确方便了很多，对于不想纠结其中网络访问过程的人来说，的确遍历了不少。除此之外，就是一些很常规的爬虫技巧，比如伪装成浏览器，通过开发者工具观察真实访问地址以及需要提交的数据等。</p>

<h2 id="微信模拟登陆">微信模拟登陆</h2>

<p>首先在谷歌上搜索了“微信模拟登陆”的关键字，查到了<a href="https://github.com/daoluan/WXSender-Python/blob/master/wxsender.py">wxsender</a>，没有下载下来运行过，但是从url来看好像和现在的不太一样，毕竟作者很长时间没有更新了，于是就重新写了一下，感谢<a href="https://github.com/daoluan">daoluan</a>的工作。</p>

<blockquote>
<p>Talk is cheap, show me the code.</p>
</blockquote>

<p>github地址<a href="https://github.com/camelshang/WechatLogin">WechatLogin</a>,全部代码如下：</p>

<pre><code class="language-python"># -*- coding:utf-8 -*-
&quot;&quot;&quot;
2015-01-16 by Camel
https://github.com/daoluan/WXSender-Python/ is acknowledged

&quot;&quot;&quot;
import requests
import hashlib
import re
import time


class WeiXin:

    def __init__(self):
        # 公众号登陆账号密码
        self.unm = &quot;your name&quot;
        self.pwd = &quot;your password&quot;
        self.token = ''
        self.fakeid = ''
        # 字典存储用户与fakeid的关系
        self.users = {}
        self.msg2user_capable = {}
        # session自动处理cookies
        self.session = requests.Session()

    def login(self):
        &quot;&quot;&quot;登陆&quot;&quot;&quot;
        headers = {
            &quot;Host&quot;: &quot;mp.weixin.qq.com&quot;,
            &quot;Referer&quot;: &quot;https://mp.weixin.qq.com/&quot;,
            &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.111 Safari/537.36&quot;
        }
        data = {
            &quot;username&quot;: self.unm,
            &quot;pwd&quot;: hashlib.md5(self.pwd).hexdigest(),
            &quot;imgcode&quot;: '',
            &quot;f&quot;: &quot;json&quot;
        }
        url_login = &quot;https://mp.weixin.qq.com/cgi-bin/login&quot;
        r_login = self.session.post(url_login, data=data, headers=headers)
        try:
            self.token = re.findall(&quot;token=(\d*)&quot;, r_login.content)[0]
            print &quot;token &quot;, self.token
            if self.token != '':
                print &quot;login success and get token!&quot;
                # 登陆之后转入首页，可去掉
                url_index = &quot;https://mp.weixin.qq.com/cgi-bin/home?t=home/index&amp;lang=zh_CN&amp;token=%s&quot; % self.token
                r_index = self.session.get(url_index)
                if r_index.status_code == 200:
                    print &quot;get the index&quot;
                else:
                    print &quot;get index failed&quot;
            else:
                print &quot;login failed&quot;
        except:
            print &quot;get token error&quot;

    def get_fakeid(self):
        &quot;&quot;&quot;得到自己的fakeid&quot;&quot;&quot;
        url_fakeid = &quot;https://mp.weixin.qq.com/cgi-bin/settingpage?t=setting/index&amp;action=index&amp;token=%s&amp;lang=zh_CN&quot; % self.token
        r_fakeid = self.session.get(url_fakeid)
        try:
            self.fakeid = re.findall(&quot;fakeid=(\d{10})&quot;, r_fakeid.content)[0]
            print &quot;get fakeid &quot;, self.fakeid
        except:
            print &quot;get fakeid error&quot;

    def get_users(self):
        &quot;&quot;&quot;微信更改网址，推荐用users_capable
           得到用户昵称和对应fakeid，写入users字典&quot;&quot;&quot;
        url_user = &quot;https://mp.weixin.qq.com/cgi-bin/contactmanage?t=user/index&amp;pageidx=0&amp;type=0&amp;token=%s&amp;lang=zh_CN&quot; % self.token
        r_user = self.session.get(url_user)
        total_users = int(re.findall(&quot;totalCount : '(\d*)'&quot;, r_user.content)[0])
        page_count = int(re.findall(&quot;pageCount : (\d*)&quot;, r_user.content)[0])
        page_size = int(re.findall(&quot;pageSize : (\d*),&quot;, r_user.content)[0])
        user_ids = []
        user_names = []
        for pageidx in xrange(page_count):
            url_userpage = &quot;https://mp.weixin.qq.com/cgi-bin/contactmanage?t=user/index&amp;pageidx=%s&amp;type=0&amp;token=%s&amp;lang=zh_CN&quot; % (
                str(pageidx), self.token)
            r_userid = self.session.get(url_userpage)
            thepage_user = re.findall(&quot;\&quot;id\&quot;:\&quot;(.*?){28}\&quot;&quot;, r_userid.content)
            thepage_username = re.findall(
                &quot;\&quot;nick_name\&quot;:\&quot;(.*?)\&quot;&quot;, r_userid.content)
            user_ids += thepage_user
            user_names += thepage_username
        self.users = dict(zip(user_names, user_ids))
        print &quot;get users done&quot;

    def get_users_capable(self):
        url_msgusers = &quot;https://mp.weixin.qq.com/cgi-bin/message?t=message/list&amp;action=&amp;keyword=&amp;offset=0&amp;count=%d&amp;day=7&amp;filterivrmsg=&amp;token=%s&amp;lang=zh_CN&quot;
        r_msgusers = self.session.get(url_msgusers % (20,self.token))
        total_msg = int(re.findall(r'total_count : (\d*)', r_msgusers.content)[0])
        r_allmsgusers = self.session.get(url_msgusers % (total_msg,self.token))
        fakeid = re.findall(r&quot;\&quot;fakeid\&quot;:\&quot;(.*?){28}\&quot;&quot;, r_allmsgusers.content)
        nick_name = re.findall(r&quot;\&quot;nick_name\&quot;:\&quot;(.*?)\&quot;&quot;, r_allmsgusers.content)
        date_time = map(int, re.findall(r&quot;\&quot;date_time\&quot;:(\d*)&quot;, r_allmsgusers.content))
        now = time.time()
        less_than_48h = [i for i in date_time if now-i &lt; 172800]
        msg_capable = len(less_than_48h)
        fakeid_capable = list(set(fakeid[:msg_capable]))
        nick_name_capable = list(set(nick_name[:msg_capable]))
        self.msg2user_capable = dict(zip(nick_name_capable, fakeid_capable))
        print &quot;get users_capable done&quot;

    def msg2user(self, msg, touserid):
        &quot;&quot;&quot;发送消息给单个指定用户&quot;&quot;&quot;
        url_msg = &quot;https://mp.weixin.qq.com/cgi-bin/singlesend?t=ajax-response&amp;f=json&amp;token=%s&amp;lang=zh_CN&quot; % self.token
        msg_headers = {
            &quot;Host&quot;: &quot;mp.weixin.qq.com&quot;,
            &quot;Origin&quot;: &quot;https://mp.weixin.qq.com&quot;,
            &quot;Referer&quot;: &quot;https://mp.weixin.qq.com/cgi-bin/singlesendpage?t=message/send&amp;action=index&amp;tofakeid=%s&amp;token=%s&amp;lang=zh_CN&quot; % (touserid, self.token),
            &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.111 Safari/537.36&quot;
        }
        msg_data = {
            &quot;token&quot;: self.token,
            &quot;lang&quot;: &quot;zh_CN&quot;,
            &quot;f&quot;: &quot;json&quot;,
            &quot;ajax&quot;: &quot;1&quot;,
            &quot;random&quot;: &quot;0.4469808244612068&quot;,
            &quot;type&quot;: &quot;1&quot;,
            &quot;content&quot;: msg,
            &quot;tofakeid&quot;: touserid,
            &quot;imgcode&quot;: ''
        }
        r_msg = self.session.post(url_msg, data=msg_data, headers=msg_headers)
        if r_msg.status_code == 200:
            err_msg = re.findall(&quot;\&quot;err_msg\&quot;:\&quot;(.*?)\&quot;&quot;, r_msg.content)[0]
            # 发送成功
            if err_msg == 'ok':
                print &quot;send msg %s to %s done&quot; % (msg,touserid)
            # 微信限制，用户48小时内没有主动发送消息，则公众号无法发送消息给该用户
            elif err_msg == 'customer block':
                print &quot;denied because the user hasn't send msg to you in the past 48 hours&quot;
            else:
                print &quot;failed,&quot;, err_msg
        else:
            print &quot;send msg to %s failed,and the err_msg %s&quot; % (touserid, r_msg.status_code)

    def msg2users(self, msg):
    	for user in self.msg2user_capable:
    		self.msg2user(msg, self.msg2user_capable[user])

    def send2user(self, msg, touser):
        &quot;&quot;&quot;msg : str
           touser : 用户的昵称&quot;&quot;&quot;
        self.login()
        self.get_fakeid()
        self.get_users_capable()
        if touser in self.msg2user_capable:
            print &quot;user %s exists&quot; % touser
            self.msg2user(msg, self.msg2user_capable[touser])
        else:
            print &quot;user %s not exists&quot; % touser

    def send2users(self, msg):
        self.login()
        self.get_fakeid()
        self.get_users_capable()
        self.msg2users(msg)


wx = WeiXin()
wx.send2user('test测试', 'Camel') # 'Camel'是我的昵称，请替换成自己的
wx.send2users('test测试二')

</code></pre>

<p>运行结果如下图所示</p>

<p><figure class="progressive"><img class="progressive__img progressive--not-loaded" data-progressive="http://7xt5lb.com2.z0.glb.clouddn.com/high/wx_res.JPG" src="http://7xt5lb.com2.z0.glb.clouddn.com/low/wx_res.JPG" alt="" /></p></figure>

<p>微信得到推送消息如下图</p>

<p><figure class="progressive"><img class="progressive__img progressive--not-loaded" data-progressive="http://7xt5lb.com2.z0.glb.clouddn.com/high/wx_res_cut_resize.jpg" src="http://7xt5lb.com2.z0.glb.clouddn.com/low/wx_res_cut_resize.jpg" alt="" /></p></figure>

<h2 id="后续工作">后续工作</h2>

<p>按照前面的设想，后续就是让服务器去不断爬自己需要的数据，然后在设定的情况下通过公众号推送给自己。或许，按照微信的发展理念，以后微信的应用号估计也很难突破主动发送消息给用户的限制，因此作为微信重度用户，个人拿来玩玩儿还是不错的。</p>
                
                <br>
                <p><a href="blog">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                
            </div>
        </div>
    </div>
</section>


  <script src="js/highlight.min.js" defer></script>
  



  <script src="js/progressively.min.js" defer></script>


<script>
  window.onload = function() {
    
      hljs.initHighlighting();
    
    
      progressively.init({delay: 30, throttle: 50});
    
  };
</script>

</body>
</html>

